#!/bin/sh

# Created By: Javier Pacheco - javier@jpacheco.xyz
# Created On: 10/02/24
# Project: Screen recorder in wayland

pkill --signal SIGINT wf-recorder
if [ $? -eq 0 ];
then
    notify-send "Video stored in /tmp/record_share.mp4"
    exit 0
fi

speakers=$(pactl list sources | grep Name | grep monitor | awk '{print $2}')

MENU="tofi" 
OPT=$(printf "record\nrecord_no_sound\nsection\nsection_no_sound\nshare" | $MENU)

remove_vid() {
    [ -f /tmp/record_share.mp4 ] && rm /tmp/record_share.mp4
}

record() {
    wf-recorder --audio=$speakers -f /tmp/record_share.mp4
}

record_ns() {
    wf-recorder -f /tmp/record_share.mp4
}

section() {
    wf-recorder --audio=$speakers -g "$(slurp)" -f /tmp/record_share.mp4
}

section_ns() {
    wf-recorder -g "$(slurp)" -f /tmp/record_share.mp4
}

kill_proc() {
    pkill --signal SIGINT wf-recorder
}

share() {
    curl -F "file=@/tmp/record_share.mp4" https://0x0.st | wl-copy
    notify-send "Video stored in 0x0.st"
}

case "$OPT" in
    record) 
        kill_proc
        remove_vid
        sleep 1
        notify-send "Recording screen" "Act natural dude..."
        record
        ;;
    record_no_sound) 
        kill_proc
        remove_vid
        sleep 1
        notify-send "Recording screen" "Act natural dude..."
        record_ns
        ;;
    section) 
        kill_proc
        remove_vid
        sleep 1
        notify-send "Recording screen" "Act natural dude..."
        section
        ;;
    section_no_sound) 
        kill_proc
        remove_vid
        sleep 1
        notify-send "Recording screen" "Act natural dude..."
        section_ns
        ;;
    share)
        share
        ;;
    *) exit 1
    ;;
esac
