#!/usr/bin/env bash

# Script interactivo para crear un puente en Linux
# Requiere: iproute2 y fzf

# Verificar si fzf estÃ¡ instalado
if ! command -v fzf &>/dev/null; then
    echo "âŒ fzf no estÃ¡ instalado. InstÃ¡lalo o modifica el script para no usar fzf."
    exit 1
fi

echo "ğŸ” Buscando interfaces disponibles..."
sleep 1

# Obtener interfaces fÃ­sicas (excluyendo lo, bridges, docker, veth, etc)
iface=$(ip -o link show | awk -F': ' '{print $2}' \
    | grep -v -E "lo|br-|docker|veth|virbr" \
    | fzf --prompt="Selecciona la interfaz a agregar al puente: ")

if [ -z "$iface" ]; then
    echo "âŒ No seleccionaste ninguna interfaz."
    exit 1
fi

echo "ğŸ‘‰ Seleccionaste: $iface"
echo ""

read -rp "ğŸ“› Nombre que quieres para el puente (ej. br0): " brname
brname=${brname:-br0}

read -rp "ğŸŒ IP que quieres asignar al puente (ej. 192.168.0.100/24): " ipaddr

echo ""
echo "âš™ï¸ Configurando puente..."
echo ""
echo "ip link add name $brname type bridge"
echo "ip link set dev $brname up"
echo "ip link set $iface master $brname"
echo "ip addr add $ipaddr dev $brname"
echo ""
read -rp "Â¿Deseas ejecutar estos comandos? (y/n): " confirm

if [[ "$confirm" != "y" ]]; then
    echo "Cancelado."
    exit 0
fi

# Ejecutar comandos reales
sudo ip link add name "$brname" type bridge
sudo ip link set dev "$brname" up
sudo ip link set "$iface" master "$brname"
sudo ip addr add "$ipaddr" dev "$brname"

echo ""
echo "âœ… Puente creado correctamente:"
echo "   - Bridge: $brname"
echo "   - Interfaz aÃ±adida: $iface"
echo "   - IP: $ipaddr"
echo ""

ip addr show "$brname"
